<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Kehadiran</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #e5e7eb; padding: 8px; text-align: left; }
    th { background-color: #f9fafb; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">

  <div class="max-w-5xl mx-auto py-10 px-4">
    <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Panel Admin Kehadiran</h1>

    <!-- Bagian Link Pengaturan -->
    <div class="bg-white p-6 rounded-2xl shadow mb-8">
      <h2 class="text-xl font-semibold text-gray-700 mb-4">Pengaturan Link Materi</h2>
      <div class="grid sm:grid-cols-2 gap-4 mb-4">
        <div>
          <label class="block text-sm font-medium text-gray-600 mb-1">Link YouTube</label>
          <input id="linkYT" type="url" placeholder="https://youtube.com/..." class="w-full px-3 py-2 border rounded-lg focus:ring focus:ring-blue-300">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-600 mb-1">Link Zoom</label>
          <input id="linkZoom" type="url" placeholder="https://zoom.us/..." class="w-full px-3 py-2 border rounded-lg focus:ring focus:ring-blue-300">
        </div>
      </div>
      <button id="btnSaveLinks" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition">Simpan Link</button>
      <p id="statusLinks" class="text-sm text-green-600 mt-2 h-5"></p>
    </div>

    <!-- Bagian Kehadiran -->
    <div class="bg-white p-6 rounded-2xl shadow">
      <h2 class="text-xl font-semibold text-gray-700 mb-4">Daftar Kehadiran Peserta</h2>
      <div class="flex items-center gap-2 mb-4">
        <label class="text-sm text-gray-600">Pilih Pekan / Tanggal:</label>
        <input type="date" id="datePicker" class="border px-3 py-2 rounded-lg focus:ring focus:ring-blue-300">
        <button id="btnLoad" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition">Muat Data</button>
      </div>
      <div class="overflow-x-auto">
        <table id="tableAttendance" class="text-sm">
          <thead>
            <tr>
              <th>Nama Peserta</th>
              <th>Device ID</th>
              <th>Waktu Hadir</th>
            </tr>
          </thead>
          <tbody id="tbodyAttendance">
            <tr><td colspan="3" class="text-center text-gray-400 py-4">Belum ada data</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script type="module">
    // Konfigurasi Firebase (sama seperti file lain)
    const firebaseConfig = {
      apiKey: "AIzaSyDyx3hfM_49dQPWrYeKBuZ_5umRPGvTjLI",
      authDomain: "greciaexperiment.firebaseapp.com",
      projectId: "greciaexperiment",
      storageBucket: "greciaexperiment.appspot.com",
      messagingSenderId: "449936532510",
      appId: "1:449936532510:web:9186754bceb92884c63a0f",
      measurementId: "G-5R08SBGN4N"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import {
      getFirestore, doc, getDoc, setDoc, collection, getDocs
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const linkYT = document.getElementById('linkYT');
    const linkZoom = document.getElementById('linkZoom');
    const btnSaveLinks = document.getElementById('btnSaveLinks');
    const statusLinks = document.getElementById('statusLinks');
    const datePicker = document.getElementById('datePicker');
    const btnLoad = document.getElementById('btnLoad');
    const tbody = document.getElementById('tbodyAttendance');

    // === Bagian 1: Load dan Simpan Link Materi ===
    async function loadLinks(){
      const ref = doc(db, 'settings', 'dashboardLinks');
      const snap = await getDoc(ref);
      if(snap.exists()){
        const data = snap.data();
        linkYT.value = data.youtube || '';
        linkZoom.value = data.zoom || '';
      }
    }

    btnSaveLinks.onclick = async()=>{
      try{
        await setDoc(doc(db, 'settings', 'dashboardLinks'), {
          youtube: linkYT.value.trim(),
          zoom: linkZoom.value.trim(),
          updatedAt: new Date().toISOString()
        }, { merge: true });
        statusLinks.textContent = 'Tautan berhasil disimpan.';
        setTimeout(()=>statusLinks.textContent='', 4000);
      }catch(err){
        console.error(err);
        statusLinks.textContent = 'Gagal menyimpan tautan.';
      }
    };

    // === Bagian 2: Load Data Kehadiran ===
    async function loadAttendance(dateKey){
      tbody.innerHTML = `<tr><td colspan="3" class="text-gray-400 text-center py-4">Memuat data...</td></tr>`;
      try{
        const colRef = collection(db, 'attendance', dateKey, 'attendees');
        const snaps = await getDocs(colRef);
        if(snaps.empty){
          tbody.innerHTML = `<tr><td colspan="3" class="text-gray-400 text-center py-4">Tidak ada data hadir pada ${dateKey}</td></tr>`;
          return;
        }
        let html='';
        snaps.forEach(docSnap=>{
          const d=docSnap.data();
          const time=d.checkedAt?.toDate?.() || (d.checkedAt?.seconds ? new Date(d.checkedAt.seconds*1000): null);
          const formatted = time ? time.toLocaleString('id-ID') : '-';
          html += `
            <tr>
              <td class="font-medium">${d.username || '(tidak diketahui)'}</td>
              <td class="text-gray-600">${d.deviceId || '-'}</td>
              <td class="text-gray-600">${formatted}</td>
            </tr>`;
        });
        tbody.innerHTML = html;
      }catch(err){
        console.error(err);
        tbody.innerHTML = `<tr><td colspan="3" class="text-center text-red-500 py-4">Gagal memuat data.</td></tr>`;
      }
    }

    btnLoad.onclick = ()=>{
      const dateVal = datePicker.value;
      if(!dateVal){ alert('Pilih tanggal terlebih dahulu.'); return; }
      loadAttendance(dateVal);
    };

    // === Inisialisasi ===
    loadLinks();
  </script>
</body>
</html>
