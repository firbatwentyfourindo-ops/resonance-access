<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Admin Absensi</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <h2>Admin Absensi</h2>

  <div>
    <label>Pilih tanggal:</label>
    <input type="date" id="tanggalInput">
    <button id="tampilkanBtn">Tampilkan Kehadiran</button>
    <button id="downloadPdfBtn">Unduh PDF</button>
  </div>

  <h3>Daftar Hadir:</h3>
  <ul id="daftarHadir"></ul>

  <h3>Ubah Link Dashboard:</h3>
  <label>Link YouTube:</label><br>
  <input type="text" id="youtubeLink" placeholder="Masukkan link YouTube"><br><br>
  <label>Link Zoom:</label><br>
  <input type="text" id="zoomLink" placeholder="Masukkan link Zoom"><br><br>
  <button id="simpanLinkBtn">Simpan Link</button>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDyx3hfM_49dQPWrYeKBuZ_5umRPGvTjLI",
      authDomain: "greciaexperiment.firebaseapp.com",
      projectId: "greciaexperiment",
      storageBucket: "greciaexperiment.appspot.com",
      messagingSenderId: "449936532510",
      appId: "1:449936532510:web:9186754bceb92884c63a0f",
      measurementId: "G-5R08SBGN4N"
    };

    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const daftarHadir = document.getElementById("daftarHadir");
    const tampilkanBtn = document.getElementById("tampilkanBtn");
    const downloadPdfBtn = document.getElementById("downloadPdfBtn");

    const youtubeLinkInput = document.getElementById("youtubeLink");
    const zoomLinkInput = document.getElementById("zoomLink");
    const simpanLinkBtn = document.getElementById("simpanLinkBtn");

    // Simpan link streaming
    simpanLinkBtn.addEventListener("click", async () => {
      const yt = youtubeLinkInput.value.trim();
      const zoom = zoomLinkInput.value.trim();
      if (!yt || !zoom) return alert("Isi semua link!");

      await db.collection("streamingLinks").doc("current").set({
        youtube: yt,
        zoom: zoom,
        updatedAt: new Date().toISOString()
      });

      alert("Link berhasil disimpan!");
    });

    // Tampilkan kehadiran berdasarkan tanggal
    tampilkanBtn.addEventListener("click", async () => {
      daftarHadir.innerHTML = "";
      const tanggal = document.getElementById("tanggalInput").value;
      if (!tanggal) return alert("Pilih tanggal dulu.");

      const q = await db.collection("absensi")
        .where("tanggal", "==", tanggal)
        .orderBy("waktu", "asc")
        .get();

      if (q.empty) {
        daftarHadir.innerHTML = "<li>Tidak ada data hadir di tanggal ini.</li>";
        return;
      }

      q.forEach(doc => {
        const data = doc.data();
        const li = document.createElement("li");
        li.textContent = `${data.username} - Hadir (${data.waktu})`;
        daftarHadir.appendChild(li);
      });
    });

    // Unduh PDF daftar hadir
    downloadPdfBtn.addEventListener("click", async () => {
      const tanggal = document.getElementById("tanggalInput").value;
      if (!tanggal) return alert("Pilih tanggal dulu sebelum unduh.");

      const q = await db.collection("absensi")
        .where("tanggal", "==", tanggal)
        .orderBy("waktu", "asc")
        .get();

      if (q.empty) return alert("Tidak ada data untuk tanggal ini.");

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(14);
      doc.text(`Daftar Hadir Pelatihan (${tanggal})`, 10, 15);
      doc.setFontSize(12);

      let y = 25;
      let i = 1;

      q.forEach(d => {
        const data = d.data();
        doc.text(`${i}. ${data.username} - Hadir (${data.waktu})`, 10, y);
        y += 8;
        i++;
        if (y > 270) { doc.addPage(); y = 15; }
      });

      doc.save(`daftar-hadir-${tanggal}.pdf`);
    });
  </script>
</body>
</html>
