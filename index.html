<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Login Absen</title>
</head>
<body>
  <h2>Login Absen Pelatihan</h2>
  <p>Masukkan nama Anda:</p>
  <input type="text" id="username">
  <button id="loginBtn">Login</button>
  <p id="status"></p>

  <script type="module">
    import { db } from "./firebase-config.js";
    import { doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const loginBtn = document.getElementById('loginBtn');
    const usernameInput = document.getElementById('username');
    const status = document.getElementById('status');

    // Jika user sudah pernah login sebelumnya, langsung ke dashboard
    const storedName = localStorage.getItem('username');
    if (storedName) {
      status.textContent = "Kamu sudah login sebagai " + storedName + ". Mengalihkan...";
      setTimeout(() => window.location.href = "dashboard.html", 1500);
    }

    loginBtn.onclick = async () => {
      const username = usernameInput.value.trim();
      if (!username) {
        alert("Nama tidak boleh kosong");
        return;
      }

      const userRef = doc(db, "users", username);
      const docSnap = await getDoc(userRef);

      if (docSnap.exists()) {
        // Sudah ada, periksa apakah nama sama dengan localStorage
        const existingName = docSnap.data().username;
        if (storedName && storedName !== existingName) {
          status.textContent = "Nama tidak cocok. Kamu harus login dengan nama: " + existingName;
          return;
        }
        localStorage.setItem("username", existingName);
        status.textContent = "Login berhasil, masuk ke dashboard...";
        setTimeout(() => window.location.href = "dashboard.html", 1000);
      } else {
        // Belum ada -> buat baru
        await setDoc(userRef, {
          username: username,
          firstLogin: new Date().toISOString()
        });
        localStorage.setItem("username", username);
        status.textContent = "Akun baru dibuat. Masuk ke dashboard...";
        setTimeout(() => window.location.href = "dashboard.html", 1000);
      }
    };
  </script>
</body>
</html>
