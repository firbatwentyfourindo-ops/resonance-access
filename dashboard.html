<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Dashboard Pelatihan</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDyx3hfM_49dQPWrYeKBuZ_5umRPGvTjLI",
      authDomain: "greciaexperiment.firebaseapp.com",
      projectId: "greciaexperiment",
      storageBucket: "greciaexperiment.appspot.com",
      messagingSenderId: "449936532510",
      appId: "1:449936532510:web:9186754bceb92884c63a0f",
      measurementId: "G-5R08SBGN4N"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const namaUser = sessionStorage.getItem("namaUser");
    if (!namaUser) window.location.href = "index.html";

    document.addEventListener("DOMContentLoaded", async () => {
      document.getElementById("namaUser").textContent = namaUser;

      // Ambil setting link acara
      const settingRef = doc(db, "setting_acara", "rabu_malam");
      const settingSnap = await getDoc(settingRef);
      if (settingSnap.exists()) {
        const data = settingSnap.data();
        document.getElementById("zoom").href = data.zoom_link || "#";
        document.getElementById("youtube").href = data.youtube_link || "#";
      }

      // Catat absen otomatis
      await addDoc(collection(db, "absensi"), {
        nama: namaUser,
        waktu_absen: new Date().toISOString()
      });

      // Timer logout otomatis setelah 5 menit
      let countdown = 300; // detik
      const interval = setInterval(async () => {
        countdown--;
        document.getElementById("timer").textContent = countdown + " detik lagi sebelum logout otomatis";

        if (countdown <= 0) {
          clearInterval(interval);
          await setDoc(doc(db, "users", namaUser), { aktif: false }, { merge: true });
          alert("Sesi Anda telah berakhir. Terima kasih sudah mengikuti acara.");
          sessionStorage.clear();
          window.location.href = "login.html";
        }
      }, 1000);
    });
  </script>
</head>
<body>
  <h2>Dashboard Peserta</h2>
  <p>Selamat datang, <b id="namaUser"></b></p>
  <p>Sesi Anda akan berakhir dalam: <span id="timer">300 detik</span></p>
  <p>
    <a id="zoom" target="_blank">Ikuti Acara via Zoom</a><br>
    <a id="youtube" target="_blank">Ikuti Acara via YouTube</a>
  </p>
  <p>Pastikan Anda tetap berada di halaman ini selama acara berlangsung untuk pencatatan kehadiran yang sah.</p>
  <button onclick="sessionStorage.clear();window.location='login.html'">Logout Manual</button>
</body>
</html>
