<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Dashboard Absen</title>
</head>
<body>
  <h2>Dashboard Absen Pelatihan</h2>
  <p id="welcome"></p>
  <p id="info"></p>
  <p id="timer"></p>
  <p><strong>Instruksi:</strong> Harap tetap di halaman ini hingga acara selesai (20:25). Jika keluar lebih awal, absensi bisa tidak dihitung.</p>

  <button id="zoomBtn">Ikuti via Zoom</button>
  <button id="ytBtn">Ikuti via YouTube</button>
  <p id="status"></p>

  <script type="module">
    import { db } from "./firebase-config.js";
    import { doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const username = localStorage.getItem("username");
    if (!username) window.location.href = "login.html";

    document.getElementById("welcome").textContent = "Selamat datang, " + username;

    const zoomBtn = document.getElementById("zoomBtn");
    const ytBtn = document.getElementById("ytBtn");
    const status = document.getElementById("status");
    const timerEl = document.getElementById("timer");

    // Hitung minggu keberapa dalam tahun ini
    function getWeekNumber(d) {
      d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
      const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
      const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
      return weekNo;
    }

    const now = new Date();
    const week = getWeekNumber(now);
    const year = now.getFullYear();
    const absensiDoc = doc(db, "absensi", `minggu_${year}_${week}`);

    // Waktu pelatihan: jam 20.00â€“20.25
    const startTime = new Date();
    startTime.setHours(20, 0, 0, 0);
    const endTime = new Date(startTime.getTime() + 25 * 60000);

    // Fungsi timer
    function updateTimer() {
      const current = new Date();
      if (current < startTime) {
        const diff = Math.floor((startTime - current) / 1000);
        const m = Math.floor(diff / 60);
        const s = diff % 60;
        timerEl.textContent = "Acara dimulai dalam: " + m + "m " + s + "s";
        zoomBtn.disabled = true;
        ytBtn.disabled = true;
      } else if (current >= startTime && current <= endTime) {
        const diff = Math.floor((endTime - current) / 1000);
        const m = Math.floor(diff / 60);
        const s = diff % 60;
        timerEl.textContent = "Waktu tersisa: " + m + "m " + s + "s";
        zoomBtn.disabled = false;
        ytBtn.disabled = false;
      } else {
        timerEl.textContent = "Waktu absen telah berakhir.";
        zoomBtn.disabled = true;
        ytBtn.disabled = true;
        localStorage.removeItem("username");
        setTimeout(() => {
          alert("Sesi absen telah berakhir. Kamu akan logout.");
          window.location.href = "login.html";
        }, 3000);
      }
    }
    setInterval(updateTimer, 1000);
    updateTimer();

    async function catatAbsen(tipe) {
      const current = new Date();
      if (current < startTime || current > endTime) {
        alert("Waktu absen tidak aktif.");
        return;
      }

      const docSnap = await getDoc(absensiDoc);
      const tanggalHariIni = current.toISOString().split("T")[0];
      let data = docSnap.exists() ? docSnap.data().data || [] : [];

      const sudahAbsen = data.some(d => d.username === username && d.tanggal === tanggalHariIni);
      if (sudahAbsen) {
        alert("Kamu sudah absen hari ini.");
        return;
      }

      data.push({
        username,
        tanggal: tanggalHariIni,
        tipe,
        waktu: current.toISOString()
      });

      await setDoc(absensiDoc, { data }, { merge: true });

      status.textContent = "Absen " + tipe + " berhasil dicatat.";
      window.open(tipe === "zoom" ? "https://zoom.us" : "https://youtube.com", "_blank");
    }

    zoomBtn.onclick = () => catatAbsen("zoom");
    ytBtn.onclick = () => catatAbsen("youtube");
  </script>
</body>
</html>
