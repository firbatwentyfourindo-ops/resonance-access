<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Absen</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col items-center justify-center">
  <div class="bg-white p-6 rounded-2xl shadow-md w-96 text-center">
    <h1 class="text-2xl font-bold mb-4">Absen Pelatihan</h1>
    <p id="userLabel" class="text-gray-700 mb-2"></p>
    <p id="timer" class="font-semibold text-red-600 mb-4"></p>

    <button id="zoomBtn" class="bg-blue-600 text-white w-full py-2 rounded mb-2 hover:bg-blue-700">Ikuti via Zoom</button>
    <button id="ytBtn" class="bg-red-600 text-white w-full py-2 rounded hover:bg-red-700">Ikuti via YouTube</button>

    <p id="status" class="mt-3 text-sm text-gray-600"></p>
  </div>

  <script type="module">
    import { db } from "./firebase-config.js";
    import { collection, addDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const username = localStorage.getItem("username");
    const userLabel = document.getElementById("userLabel");
    const status = document.getElementById("status");
    const timerEl = document.getElementById("timer");

    if (!username) window.location.href = "login.html";
    userLabel.textContent = `Selamat datang, ${username}`;

    const startTime = new Date();
    startTime.setHours(7, 0, 0, 0);
    const endTime = new Date(startTime.getTime() + 25 * 60000);

    function updateTimer() {
      const now = new Date();
      if (now > endTime) {
        timerEl.textContent = "⏰ Waktu absen telah berakhir";
        document.querySelectorAll("button").forEach(b => b.disabled = true);
      } else {
        const sisa = Math.floor((endTime - now) / 1000);
        const m = Math.floor(sisa / 60);
        const s = sisa % 60;
        timerEl.textContent = `Waktu tersisa: ${m}m ${s}s`;
      }
    }
    setInterval(updateTimer, 1000);
    updateTimer();

    async function catatAbsen(tipe) {
      const now = new Date();
      if (now > endTime) return alert("Waktu absen sudah habis!");

      const q = query(collection(db, "absensi"), where("username", "==", username), where("tipe", "==", tipe));
      const snap = await getDocs(q);
      if (!snap.empty) return alert("Kamu sudah absen sebelumnya!");

      await addDoc(collection(db, "absensi"), {
        username,
        tipe,
        waktu: now.toISOString()
      });

      status.textContent = `✅ Absen ${tipe} berhasil dicatat.`;
      window.open(tipe === "zoom" ? "https://zoom.us" : "https://youtube.com", "_blank");
    }

    document.getElementById("zoomBtn").onclick = () => catatAbsen("zoom");
    document.getElementById("ytBtn").onclick = () => catatAbsen("youtube");
  </script>
</body>
</html>
