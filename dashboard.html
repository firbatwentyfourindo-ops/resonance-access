<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Dashboard Pelatihan</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDyx3hfM_49dQPWrYeKBuZ_5umRPGvTjLI",
      authDomain: "greciaexperiment.firebaseapp.com",
      projectId: "greciaexperiment",
      storageBucket: "greciaexperiment.appspot.com",
      messagingSenderId: "449936532510",
      appId: "1:449936532510:web:9186754bceb92884c63a0f",
      measurementId: "G-5R08SBGN4N"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const namaUser = sessionStorage.getItem("namaUser");
    if (!namaUser) window.location.href = "login.html";

    document.addEventListener("DOMContentLoaded", async () => {
      document.getElementById("namaUser").textContent = namaUser;

      // Ambil setting acara
      const settingRef = doc(db, "setting_acara", "rabu_malam");
      const settingSnap = await getDoc(settingRef);
      if (settingSnap.exists()) {
        const data = settingSnap.data();
        document.getElementById("zoom").href = data.zoom_link;
        document.getElementById("youtube").href = data.youtube_link;
        document.getElementById("mulai").textContent = new Date(data.jadwal_mulai).toLocaleString("id-ID");

        // Catat absen user
        await addDoc(collection(db, "absensi"), {
          nama: namaUser,
          waktu_absen: new Date().toISOString(),
        });

        // Timer auto logout
        const start = new Date(data.jadwal_mulai);
        const end = new Date(start.getTime() + data.durasi_menit * 60000);
        const interval = setInterval(() => {
          const now = new Date();
          const diff = end - now;
          if (diff <= 0) {
            alert("Waktu belajar sudah selesai. Anda akan logout otomatis.");
            sessionStorage.clear();
            window.location.href = "login.html";
          } else {
            const menit = Math.floor(diff / 60000);
            const detik = Math.floor((diff % 60000) / 1000);
            document.getElementById("timer").textContent = `${menit}m ${detik}s`;
          }
        }, 1000);
      } else {
        document.getElementById("info").textContent = "Belum ada jadwal pelatihan saat ini.";
      }
    });
  </script>
</head>
<body>
  <h2>Dashboard Peserta</h2>
  <p>Selamat datang, <b id="namaUser"></b></p>
  <p id="info">Waktu mulai: <span id="mulai"></span></p>
  <p>Sisa waktu belajar: <span id="timer">-</span></p>
  <p>
    <a id="zoom" target="_blank">Link Zoom</a> | 
    <a id="youtube" target="_blank">Link YouTube</a>
  </p>
  <button onclick="sessionStorage.clear();window.location='login.html'">Logout</button>
</body>
</html>
